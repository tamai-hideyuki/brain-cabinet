{
  "openapi": "3.1.0",
  "info": {
    "title": "Brain Cabinet API",
    "description": "個人の思考ログを構造化し、GPTと連携して再利用するためのナレッジ基盤API",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:3000/api",
      "description": "ローカル開発サーバー"
    }
  ],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "search_notes",
        "description": "Brain Cabinetのノートを検索します。キーワード、カテゴリ、タグでフィルタリング可能。質問に答える前に必ず呼び出してください。",
        "parameters": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string",
              "description": "検索キーワード（必須）"
            },
            "searchIn": {
              "type": "string",
              "description": "検索対象をカンマ区切りで指定。title,content,tags,headings から選択。デフォルト: title,content,tags"
            },
            "category": {
              "type": "string",
              "description": "カテゴリでフィルタリング。選択肢: 技術, 心理, 健康, 仕事, 習慣, 学習, 創作, アイデア, 日記, その他"
            },
            "limit": {
              "type": "integer",
              "description": "取得件数の上限。デフォルト: 10"
            },
            "includeHistory": {
              "type": "boolean",
              "description": "履歴件数を含めるか。デフォルト: false"
            }
          },
          "required": ["query"]
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "get_note_context",
        "description": "特定のノートの詳細コンテキストを取得します。全文、履歴、アウトラインなどを含む。",
        "parameters": {
          "type": "object",
          "properties": {
            "noteId": {
              "type": "string",
              "description": "ノートID（必須）"
            },
            "full": {
              "type": "boolean",
              "description": "全文を含めるか。デフォルト: true"
            },
            "history": {
              "type": "boolean",
              "description": "履歴を含めるか。デフォルト: true"
            },
            "historyLimit": {
              "type": "integer",
              "description": "履歴の件数制限。デフォルト: 3"
            },
            "outline": {
              "type": "boolean",
              "description": "アウトラインを含めるか。デフォルト: true"
            },
            "bullets": {
              "type": "boolean",
              "description": "箇条書きを含めるか。デフォルト: false"
            }
          },
          "required": ["noteId"]
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "prepare_task",
        "description": "GPT向けタスクを準備します。要約、要点抽出、アイデア生成などの処理に使用。",
        "parameters": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": [
                "extract_key_points",
                "summarize",
                "generate_ideas",
                "find_related",
                "compare_versions",
                "create_outline"
              ],
              "description": "タスクタイプ（必須）。extract_key_points: 要点抽出, summarize: 要約, generate_ideas: アイデア生成, find_related: 関連検索, compare_versions: 履歴比較, create_outline: アウトライン作成"
            },
            "noteId": {
              "type": "string",
              "description": "対象ノートID（find_related以外は必須）"
            },
            "query": {
              "type": "string",
              "description": "検索クエリ（find_relatedで使用）"
            }
          },
          "required": ["type"]
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "get_overview",
        "description": "Brain Cabinet全体の統計情報を取得します。会話開始時や全体像把握に使用。",
        "parameters": {
          "type": "object",
          "properties": {},
          "required": []
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "get_note_with_history",
        "description": "ノートと最新の履歴を軽量に取得します。簡易的な履歴確認に使用。",
        "parameters": {
          "type": "object",
          "properties": {
            "noteId": {
              "type": "string",
              "description": "ノートID（必須）"
            },
            "limit": {
              "type": "integer",
              "description": "履歴の件数制限。デフォルト: 5"
            }
          },
          "required": ["noteId"]
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "get_full_context",
        "description": "ノート全体 + 全履歴 + HTML diff を取得します。詳細な変更分析に使用。",
        "parameters": {
          "type": "object",
          "properties": {
            "noteId": {
              "type": "string",
              "description": "ノートID（必須）"
            }
          },
          "required": ["noteId"]
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "search_keyword",
        "description": "キーワード検索（シンプル版）。TF-IDFスコアリングで関連性の高いノートを返す。",
        "parameters": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string",
              "description": "検索キーワード（必須）"
            },
            "category": {
              "type": "string",
              "description": "カテゴリフィルター"
            },
            "tag": {
              "type": "string",
              "description": "タグフィルター"
            }
          },
          "required": ["query"]
        }
      }
    },
    {
      "type": "function",
      "function": {
        "name": "get_available_tasks",
        "description": "利用可能なタスクタイプの一覧と説明を取得します。",
        "parameters": {
          "type": "object",
          "properties": {},
          "required": []
        }
      }
    }
  ],
  "paths": {
    "/api/gpt/search": {
      "get": {
        "operationId": "search_notes",
        "summary": "GPT向け複合検索",
        "description": "キーワード、カテゴリ、タグで検索し、関連度付きの結果を返す",
        "parameters": [
          {
            "name": "query",
            "in": "query",
            "required": true,
            "schema": { "type": "string" },
            "description": "検索クエリ"
          },
          {
            "name": "searchIn",
            "in": "query",
            "schema": { "type": "string" },
            "description": "検索対象（カンマ区切り）: title,content,tags,headings"
          },
          {
            "name": "category",
            "in": "query",
            "schema": { "type": "string" },
            "description": "カテゴリフィルター"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 10 },
            "description": "取得件数"
          },
          {
            "name": "includeHistory",
            "in": "query",
            "schema": { "type": "boolean", "default": false },
            "description": "履歴件数を含める"
          }
        ],
        "responses": {
          "200": {
            "description": "検索結果",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "string" },
                          "title": { "type": "string" },
                          "category": { "type": "string" },
                          "tags": { "type": "array", "items": { "type": "string" } },
                          "headings": { "type": "array", "items": { "type": "string" } },
                          "summary": { "type": "string" },
                          "relevance": { "type": "string", "enum": ["high", "medium", "low"] },
                          "updatedAt": { "type": "integer" },
                          "historyCount": { "type": "integer" }
                        }
                      }
                    },
                    "totalFound": { "type": "integer" },
                    "searchContext": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/gpt/notes/{id}/context": {
      "get": {
        "operationId": "get_note_context",
        "summary": "GPT向けコンテキスト取得",
        "description": "ノートの詳細情報（全文、履歴、アウトライン）を取得",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "ノートID"
          },
          {
            "name": "full",
            "in": "query",
            "schema": { "type": "boolean", "default": true },
            "description": "全文を含める"
          },
          {
            "name": "history",
            "in": "query",
            "schema": { "type": "boolean", "default": true },
            "description": "履歴を含める"
          },
          {
            "name": "historyLimit",
            "in": "query",
            "schema": { "type": "integer", "default": 3 },
            "description": "履歴件数制限"
          },
          {
            "name": "outline",
            "in": "query",
            "schema": { "type": "boolean", "default": true },
            "description": "アウトラインを含める"
          },
          {
            "name": "bullets",
            "in": "query",
            "schema": { "type": "boolean", "default": false },
            "description": "箇条書きを含める"
          }
        ],
        "responses": {
          "200": {
            "description": "ノートコンテキスト",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "note": {
                      "type": "object",
                      "properties": {
                        "id": { "type": "string" },
                        "title": { "type": "string" },
                        "category": { "type": "string" },
                        "tags": { "type": "array", "items": { "type": "string" } },
                        "headings": { "type": "array", "items": { "type": "string" } },
                        "createdAt": { "type": "integer" },
                        "updatedAt": { "type": "integer" }
                      }
                    },
                    "content": {
                      "type": "object",
                      "properties": {
                        "full": { "type": "string" },
                        "outline": { "type": "array", "items": { "type": "string" } },
                        "bulletPoints": { "type": "array", "items": { "type": "string" } },
                        "summary": { "type": "string" }
                      }
                    },
                    "history": {
                      "type": "object",
                      "properties": {
                        "count": { "type": "integer" },
                        "recent": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "id": { "type": "string" },
                              "createdAt": { "type": "integer" },
                              "summary": { "type": "string" }
                            }
                          }
                        }
                      }
                    },
                    "gptInstruction": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/gpt/task": {
      "post": {
        "operationId": "prepare_task",
        "summary": "GPT向けタスク準備",
        "description": "要約、要点抽出、アイデア生成などのタスクを準備",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "type": {
                    "type": "string",
                    "enum": [
                      "extract_key_points",
                      "summarize",
                      "generate_ideas",
                      "find_related",
                      "compare_versions",
                      "create_outline"
                    ],
                    "description": "タスクタイプ"
                  },
                  "noteId": {
                    "type": "string",
                    "description": "対象ノートID"
                  },
                  "query": {
                    "type": "string",
                    "description": "検索クエリ（find_related用）"
                  },
                  "options": {
                    "type": "object",
                    "description": "追加オプション"
                  }
                },
                "required": ["type"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "タスク準備結果",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "type": { "type": "string" },
                    "instruction": { "type": "string" },
                    "context": { "type": "string" },
                    "suggestedPrompt": { "type": "string" },
                    "relatedNoteIds": {
                      "type": "array",
                      "items": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/gpt/overview": {
      "get": {
        "operationId": "get_overview",
        "summary": "Brain Cabinet概要",
        "description": "全ノートの統計情報を取得",
        "responses": {
          "200": {
            "description": "概要情報",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "totalNotes": { "type": "integer" },
                    "totalHistoryEntries": { "type": "integer" },
                    "categoryBreakdown": {
                      "type": "object",
                      "additionalProperties": { "type": "integer" }
                    },
                    "topTags": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "tag": { "type": "string" },
                          "count": { "type": "integer" }
                        }
                      }
                    },
                    "gptSummary": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/gpt/tasks": {
      "get": {
        "operationId": "get_available_tasks",
        "summary": "利用可能タスク一覧",
        "description": "タスクタイプの一覧と説明を取得",
        "responses": {
          "200": {
            "description": "タスク一覧",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "availableTasks": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "type": { "type": "string" },
                          "description": { "type": "string" },
                          "requiresNoteId": { "type": "boolean" },
                          "requiresQuery": { "type": "boolean" },
                          "example": { "type": "object" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/notes/{id}/with-history": {
      "get": {
        "operationId": "get_note_with_history",
        "summary": "ノート + 履歴（軽量版）",
        "description": "ノートと最新N件の履歴を取得",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 5 }
          }
        ],
        "responses": {
          "200": {
            "description": "ノートと履歴"
          }
        }
      }
    },
    "/api/notes/{id}/full-context": {
      "get": {
        "operationId": "get_full_context",
        "summary": "フルコンテキスト",
        "description": "ノート全体 + 全履歴 + HTML diff",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "フルコンテキスト"
          }
        }
      }
    },
    "/api/search": {
      "get": {
        "operationId": "search_keyword",
        "summary": "キーワード検索",
        "description": "TF-IDFスコアリングでノートを検索",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "required": true,
            "schema": { "type": "string" }
          },
          {
            "name": "category",
            "in": "query",
            "schema": { "type": "string" }
          },
          {
            "name": "tag",
            "in": "query",
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "検索結果"
          }
        }
      }
    }
  }
}
